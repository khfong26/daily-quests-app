<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Quests - Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1a1a2e;
      color: #e6e6e6;
      margin: 20px;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin: 20px 0;
    }
    .stat {
      background: #333;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
    }
    .quest {
      background: #444;
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .quest.completed {
      background: #2d5a2d;
    }
    button {
      background: #666;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
    }
    button:hover {
      background: #777;
    }
    .controls {
      margin: 20px 0;
    }
    input, select {
      background: #333;
      color: white;
      border: 1px solid #666;
      padding: 5px;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>Daily Quests App - Test Mode</h1>
  
  <div class="stats">
    <div class="stat">
      <div>Streak</div>
      <div id="streak">0</div>
    </div>
    <div class="stat">
      <div>Combo</div>
      <div id="combo">1</div>
    </div>
    <div class="stat">
      <div>XP</div>
      <div id="xp">0</div>
    </div>
  </div>

  <div class="controls">
    <input type="text" id="questName" placeholder="Quest name">
    <select id="questType">
      <option value="main">Main Quest</option>
      <option value="side">Side Quest</option>
    </select>
    <select id="questFrequency">
      <option value="normal">Normal</option>
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
    </select>
    <button onclick="addQuest()">Add Quest</button>
    <button onclick="simulateNewDay()">Simulate New Day</button>
    <button onclick="clearData()">Clear Data</button>
  </div>

  <div id="quests"></div>

  <div style="margin-top: 20px;">
    <h3>Console Log:</h3>
    <div id="log" style="background: #222; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;"></div>
  </div>

  <script>
    // Simple app state
    let appState = {
      quests: [],
      xp: 0,
      streak: 0,
      combo: 1,
      lastActiveDate: null,
      dailyMainQuestCompleted: false
    };

    // Load from localStorage
    function loadState() {
      const saved = localStorage.getItem('testDailyQuests');
      if (saved) {
        appState = {...appState, ...JSON.parse(saved)};
      }
      updateUI();
    }

    // Save to localStorage
    function saveState() {
      localStorage.setItem('testDailyQuests', JSON.stringify(appState));
    }

    // Log function
    function log(message) {
      console.log(message);
      const logDiv = document.getElementById('log');
      logDiv.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // Check for new day
    function checkNewDay() {
      const today = new Date().toDateString();
      
      if (appState.lastActiveDate && appState.lastActiveDate !== today) {
        log("New day detected! Last active: " + appState.lastActiveDate + ", Today: " + today);
        
        // Check if any main quests were completed the previous day
        const hadMainQuestCompletedYesterday = appState.quests.some(q => q.type === "main" && q.done);
        
        if (hadMainQuestCompletedYesterday) {
          appState.streak = appState.streak + 1;
          log("Streak incremented - main quests were completed yesterday. New streak: " + appState.streak);
        } else {
          appState.streak = 0;
          log("Streak reset - no main quests completed yesterday. New streak: " + appState.streak);
        }
        
        // Reset daily quests
        appState.quests = appState.quests.map(q => {
          if (q.frequency === 'daily') {
            return { ...q, done: false };
          }
          return q;
        });
        
        // Reset combo
        appState.combo = 1;
        appState.dailyMainQuestCompleted = false;
        
        log("Daily quests reset and combo reset to 1");
      }
      
      if (appState.lastActiveDate !== today) {
        appState.lastActiveDate = today;
      }
      
      saveState();
      updateUI();
    }

    // Add quest
    function addQuest() {
      const name = document.getElementById('questName').value.trim();
      const type = document.getElementById('questType').value;
      const frequency = document.getElementById('questFrequency').value;
      
      if (name) {
        appState.quests.push({ name, type, frequency, done: false });
        document.getElementById('questName').value = '';
        log("Added quest: " + name + " (" + type + ", " + frequency + ")");
        saveState();
        updateUI();
      }
    }

    // Toggle quest
    function toggleQuest(index) {
      const quest = appState.quests[index];
      
      if (!quest.done) {
        // Completing quest
        let gained = quest.type === "main" ? 20 : 8;
        gained *= appState.combo;
        appState.xp += gained;
        appState.combo += 1;
        
        if (quest.type === "main") {
          appState.dailyMainQuestCompleted = true;
        }
        
        log("Completed " + quest.name + ". Gained " + gained + " XP. Combo now: " + appState.combo);
      } else {
        // Undoing quest
        let lost = quest.type === "main" ? 20 : 8;
        lost *= (appState.combo > 1 ? appState.combo - 1 : 1);
        appState.xp = Math.max(0, appState.xp - lost);
        appState.combo = Math.max(1, appState.combo - 1);
        
        if (quest.type === "main") {
          const stillHasCompletedMain = appState.quests.some((q, i) => i !== index && q.done && q.type === "main");
          if (!stillHasCompletedMain) {
            appState.dailyMainQuestCompleted = false;
          }
        }
        
        log("Undid " + quest.name + ". Lost " + lost + " XP. Combo now: " + appState.combo);
      }
      
      quest.done = !quest.done;
      saveState();
      updateUI();
    }

    // Simulate new day
    function simulateNewDay() {
      // Set last active date to yesterday
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      appState.lastActiveDate = yesterday.toDateString();
      log("Set last active date to: " + appState.lastActiveDate);
      
      // Check for new day
      checkNewDay();
    }

    // Clear all data
    function clearData() {
      localStorage.removeItem('testDailyQuests');
      appState = {
        quests: [],
        xp: 0,
        streak: 0,
        combo: 1,
        lastActiveDate: null,
        dailyMainQuestCompleted: false
      };
      log("Cleared all data");
      updateUI();
    }

    // Update UI
    function updateUI() {
      document.getElementById('streak').textContent = appState.streak;
      document.getElementById('combo').textContent = appState.combo;
      document.getElementById('xp').textContent = appState.xp;
      
      const questsDiv = document.getElementById('quests');
      questsDiv.innerHTML = '';
      
      appState.quests.forEach((quest, index) => {
        const questDiv = document.createElement('div');
        questDiv.className = 'quest' + (quest.done ? ' completed' : '');
        questDiv.innerHTML = `
          <span>${quest.name} (${quest.type}, ${quest.frequency})</span>
          <button onclick="toggleQuest(${index})">${quest.done ? 'Undo' : 'Complete'}</button>
        `;
        questsDiv.appendChild(questDiv);
      });
    }

    // Initialize
    loadState();
    checkNewDay();
    log("App initialized");
  </script>
</body>
</html>